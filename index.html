<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>請求書作成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .input-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .preview-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            display: flex;
            justify-content: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .item-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .item-row input {
            flex: 1;
        }
        .client-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .client-row input {
            flex: 1;
        }
        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            text-align: center;
            font-weight: normal;
            background-color: #fff;
        }
        .total-row {
            background-color: #f2f2f2;
        }
        .right-align {
            text-align: right;
        }
        .total-line {
            display: inline-block;
            border-bottom: 2px solid #000;
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0;
        }
        .hidden {
            display: none;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 28px;
            margin-top: 0;
        }
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .invoice-title {
            font-size: 32px;
            font-weight: bold;
        }
        .invoice-date {
            margin-bottom: 10px;
        }
        .invoice-to {
            margin: 20px 0;
        }
        .notes-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            white-space: pre-wrap;
        }
        #preview {
            width: 210mm;
            height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            box-sizing: border-box;
            background-color: white;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .radio-label input {
            width: auto;
        }
        @media print {
            .input-section, .btn-group {
                display: none;
            }
            .preview-section {
                border: none;
                width: 100%;
                height: 100%;
                padding: 0;
            }
            #preview {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <h1>請求書作成</h1>
    <div class="container">
        <div class="input-section">
            <!-- 請求先ブロック内に、一人当たり金額セクションを氏名入力欄の上部に配置 -->
            <div class="form-group">
                <label>請求先:</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="client-mode" value="single" checked> 一人
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="client-mode" value="multiple"> 複数人
                    </label>
                </div>
                <!-- ここに一人当たりの金額セクションを配置 -->
                <div id="per-person-amount-section" class="form-group" style="display: none;">
                    <label>一人当たりの金額：</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="per-amount-mode" value="same" checked> 同額
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="per-amount-mode" value="different"> 異なる
                        </label>
                    </div>
                </div>
                <div id="clients-container">
                    <div class="client-row" data-row="1">
                        <input type="text" class="client-name" placeholder="例: 山田 太郎" oninput="handleClientInput(this)">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="date">請求日:</label>
                <input type="date" id="date">
            </div>
            <div class="form-group">
                <label for="tax-rate">消費税率 (%):</label>
                <select id="tax-rate">
                    <option value="10">10%</option>
                    <option value="8">8%</option>
                    <option value="0">0%</option>
                </select>
            </div>
            <!-- 品名入力欄全体（ラベル含む）を items-section としてグループ化 -->
            <div class="form-group" id="items-section">
                <label>品名:</label>
                <div id="items-container">
                    <div class="item-row" data-row="1">
                        <input type="text" class="item-name" placeholder="品名" oninput="handleItemInput(this)">
                        <input type="number" class="item-quantity" placeholder="数量" onchange="calculateAmount(this)">
                        <input type="number" class="item-price" placeholder="単価" onchange="calculateAmount(this)">
                        <input type="number" class="item-amount" placeholder="金額" readonly>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="notes">備考:</label>
                <textarea id="notes" rows="4" placeholder="備考欄"></textarea>
            </div>
            <div class="btn-group">
                <button id="update-btn">更新</button>
                <button id="download-btn">PDFで保存</button>
            </div>
        </div>
        <div class="preview-section">
            <div id="preview">
                <!-- 請求書プレビューはここに表示されます -->
            </div>
        </div>
    </div>

    <script>
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 今日の日付をデフォルトで設定
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

            // 更新ボタンのイベントリスナー
            document.getElementById('update-btn').addEventListener('click', updatePreview);

            // PDFで保存ボタンのイベントリスナー
            document.getElementById('download-btn').addEventListener('click', downloadPDF);
            
            // 初期化処理
            document.addEventListener('DOMContentLoaded', function () {
                const defaultRadio = document.querySelector('input[name="client-mode"][value="single"]');
                if (defaultRadio) {
                    defaultRadio.checked = true; // デフォルトで「単一人モード」を選択
                    defaultRadio.dispatchEvent(new Event('change')); // changeイベントを手動でトリガー
                }
            });

            // クライアントモードのラジオボタン変更イベント
            document.querySelectorAll('input[name="client-mode"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'multiple') {
                        const rows = document.querySelectorAll('.client-row');
                        if (rows.length > 1) {
                            for (let i = rows.length - 1; i > 0; i--) {
                                rows[i].remove();
                            }
                        }
                        const firstRowInput = document.querySelector('.client-row[data-row="1"] .client-name');
                        const value = firstRowInput.value;
                        if (value.trim().length > 0) {
                            addNewClientRow(2);
                        }
                    }
                    if (this.value === 'single') {
                        const rows = document.querySelectorAll('.client-row');
                        if (rows.length > 1) {
                            for (let i = rows.length - 1; i > 0; i--) {
                                rows[i].remove();
                            }
                        }
                    }
                    updatePerAmountSection();
                    updatePreview();
                });
            });
            // 重複するイベントリスナーも同様に追加
            document.querySelectorAll('input[name="client-mode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePerAmountSection();
                    updatePreview();
                });
            });
            
            // 一人当たり金額モードの変更イベント
            document.querySelectorAll('input[name="per-amount-mode"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'different') {
                        // 品名入力欄全体を非表示に（ラベル含む）
                        document.getElementById('items-section').style.display = 'none';
                        document.querySelectorAll('.client-row').forEach(row => {
                            if (!row.querySelector('.client-amount')) {
                                const amountInput = document.createElement('input');
                                amountInput.type = 'number';
                                amountInput.className = 'client-amount';
                                amountInput.placeholder = '金額';
                                amountInput.style.marginLeft = '10px';
                                row.appendChild(amountInput);
                            }
                        });
                    } else {
                        document.getElementById('items-section').style.display = 'block';
                        document.querySelectorAll('.client-amount').forEach(input => input.remove());
                    }
                    updatePreview();
                });
            });
            
            // 初回のプレビュー表示
            updatePreview();
        });

        // 複数人モード時の一人当たり金額セクションの表示切替
        function updatePerAmountSection() {
            const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
            if (clientMode === 'multiple') {
                document.getElementById('per-person-amount-section').style.display = 'block';
            } else {
                document.getElementById('per-person-amount-section').style.display = 'none';
                document.getElementById('items-section').style.display = 'block';
                document.querySelectorAll('.client-amount').forEach(input => input.remove());
            }
        }

        // クライアント名入力の処理
        function handleClientInput(input) {
            const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
            if (clientMode === 'single') {
                updatePreview();
                return;
            }
            const row = input.closest('.client-row');
            const rowNumber = parseInt(row.getAttribute('data-row'));
            const clientName = input.value.trim();
            if (clientMode === 'multiple') {
                if (clientName.length > 0) {
                    const nextRow = document.querySelector(`.client-row[data-row="${rowNumber + 1}"]`);
                    if (!nextRow) {
                        addNewClientRow(rowNumber + 1);
                    }
                } else {
                    if (rowNumber > 1) {
                        const hasNextRows = document.querySelector(`.client-row[data-row="${rowNumber + 1}"]`);
                        if (!hasNextRows) {
                            row.remove();
                            updateClientRowNumbers();
                        }
                    }
                }
                cleanupEmptyClientRows();
            }
            updatePreview();
        }

        function cleanupEmptyClientRows() {
            const rows = document.querySelectorAll('.client-row');
            if (rows.length > 1) {
                for (let i = 1; i < rows.length; i++) {
                    const currentRow = rows[i];
                    const prevRow = rows[i-1];
                    const currentInput = currentRow.querySelector('.client-name');
                    const prevInput = prevRow.querySelector('.client-name');
                    if (currentInput.value.trim() === '' && prevInput.value.trim() === '') {
                        currentRow.remove();
                        updateClientRowNumbers();
                        cleanupEmptyClientRows();
                        break;
                    }
                }
            }
        }

        // 変更済み：新規クライアント行追加時、"異なる"モードの場合は金額入力欄を追加
        function addNewClientRow(rowNumber) {
            const container = document.getElementById('clients-container');
            const newRow = document.createElement('div');
            newRow.className = 'client-row';
            newRow.setAttribute('data-row', rowNumber);
            newRow.innerHTML = `<input type="text" class="client-name" placeholder="例: 山田 太郎" oninput="handleClientInput(this)">`;
            const perAmountMode = document.querySelector('input[name="per-amount-mode"]:checked');
            if (perAmountMode && perAmountMode.value === 'different'){
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.className = 'client-amount';
                amountInput.placeholder = '金額';
                amountInput.style.marginLeft = '10px';
                newRow.appendChild(amountInput);
            }
            container.appendChild(newRow);
        }

        function updateClientRowNumbers() {
            const rows = document.querySelectorAll('.client-row');
            rows.forEach((row, index) => {
                row.setAttribute('data-row', index + 1);
            });
        }

        function handleItemInput(input) {
            const row = input.closest('.item-row');
            const rowNumber = parseInt(row.getAttribute('data-row'));
            const itemName = input.value.trim();
            if (itemName.length > 0) {
                const nextRow = document.querySelector(`.item-row[data-row="${rowNumber + 1}"]`);
                if (!nextRow) {
                    addNewRow(rowNumber + 1);
                }
            } else {
                if (rowNumber > 1) {
                    const hasNextRows = document.querySelector(`.item-row[data-row="${rowNumber + 1}"]`);
                    if (!hasNextRows) {
                        row.querySelectorAll('input').forEach(input => input.value = '');
                    } else {
                        row.remove();
                        updateRowNumbers();
                    }
                } else {
                    const hasNextRows = document.querySelector(`.item-row[data-row="2"]`);
                    if (!hasNextRows) {
                        row.querySelectorAll('input').forEach(input => {
                            if (!input.classList.contains('item-name')) {
                                input.value = '';
                            }
                        });
                    } else {
                        row.querySelectorAll('input').forEach(input => input.value = '');
                    }
                }
            }
            const firstRow = document.querySelector('.item-row[data-row="1"]');
            const secondRow = document.querySelector('.item-row[data-row="2"]');
            if (firstRow && secondRow) {
                const firstRowEmpty = firstRow.querySelector('.item-name').value.trim() === '';
                const secondRowEmpty = secondRow.querySelector('.item-name').value.trim() === '';
                if (firstRowEmpty && secondRowEmpty) {
                    secondRow.remove();
                }
            }
            calculateTotals();
            updatePreview();
        }

        function addNewRow(rowNumber) {
            const container = document.getElementById('items-container');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.setAttribute('data-row', rowNumber);
            newRow.innerHTML = `
                <input type="text" class="item-name" placeholder="品名" oninput="handleItemInput(this)">
                <input type="number" class="item-quantity" placeholder="数量" onchange="calculateAmount(this)">
                <input type="number" class="item-price" placeholder="単価" onchange="calculateAmount(this)">
                <input type="number" class="item-amount" placeholder="金額" readonly>
            `;
            container.appendChild(newRow);
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('.item-row');
            rows.forEach((row, index) => {
                row.setAttribute('data-row', index + 1);
            });
        }

        function calculateAmount(input) {
            const row = input.closest('.item-row');
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const amount = quantity * price;
            row.querySelector('.item-amount').value = amount;
            calculateTotals();
            updatePreview();
        }

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-amount').forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });
            const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100;
            const tax = Math.floor(subtotal * taxRate);
            const total = subtotal + tax;
            return {
                subtotal: subtotal,
                taxRate: taxRate,
                tax: tax,
                total: total
            };
        }

        // プレビューの更新
        function updatePreview() {
            const dateInput = document.getElementById('date').value || '';
            const notes = document.getElementById('notes').value || '';
            const taxRate = parseFloat(document.getElementById('tax-rate').value);
            const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
            let formattedDate = '';
            if (dateInput) {
                const date = new Date(dateInput);
                formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            }
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                if (name) {
                    items.push({
                        name: name,
                        quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                        price: parseFloat(row.querySelector('.item-price').value) || 0,
                        amount: parseFloat(row.querySelector('.item-amount').value) || 0
                    });
                }
            });
            const totals = calculateTotals();
            if (clientMode === 'single') {
                const client = document.querySelector('.client-row .client-name').value || '';
                generateInvoicePreview(client, formattedDate, items, totals, notes);
            } else {
                const perAmountMode = document.querySelector('input[name="per-amount-mode"]') ? document.querySelector('input[name="per-amount-mode"]:checked').value : 'same';
                const client = document.querySelector('.client-row .client-name').value || '';
                if (perAmountMode === 'different') {
                    generateInvoicePreview(client, formattedDate, items, totals, notes);
                } else {
                    generateInvoicePreview(client, formattedDate, items, totals, notes);
                }
            }
        }

        // プレビュー生成（「異なる」モードの場合は各クライアントの金額を表示）
        function generateInvoicePreview(client, formattedDate, items, totals, notes) {
            if(document.querySelector('input[name="per-amount-mode"]') && document.querySelector('input[name="per-amount-mode"]:checked').value === 'different') {
                let clientAmount = '0';
                const currentClientRow = document.querySelector('.client-row');
                if(currentClientRow) {
                    const amountInput = currentClientRow.querySelector('.client-amount');
                    clientAmount = amountInput ? (parseFloat(amountInput.value) || 0).toLocaleString() : '0';
                }
                const previewHTML = `
                    <div class="invoice-header">
                        <div class="invoice-title">請求書</div>
                        <div class="invoice-date">請求日: ${formattedDate}</div>
                    </div>
                    <div class="invoice-to">${client} 様</div>
                    <p>下記の通りご請求申し上げます。</p>
                    <div class="total-line">請求金額　　¥${clientAmount}-</div>
                    <div class="notes-container">備考: ${notes.replace(/\n/g, '<br>')}</div>
                `;
                document.getElementById('preview').innerHTML = previewHTML;
                return;
            }
            let previewHTML = `
                <div class="invoice-header">
                    <div class="invoice-title">請求書</div>
                    <div class="invoice-date">請求日: ${formattedDate}</div>
                </div>
                <div class="invoice-to">${client} 様</div>
                <p>下記の通りご請求申し上げます。</p>
                <div class="total-line">合計金額　　¥${totals.total.toLocaleString()}-</div>
                <br>
                <table>
                    <thead>
                        <tr>
                            <th>品名</th>
                            <th>数量</th>
                            <th>単価</th>
                            <th>金額</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach(item => {
                previewHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>¥${item.price.toLocaleString()}</td>
                        <td>¥${item.amount.toLocaleString()}</td>
                    </tr>
                `;
            });
            previewHTML += `
                    <tr>
                        <td colspan="3" class="right-align">小計</td>
                        <td>¥${totals.subtotal.toLocaleString()}</td>
                    </tr>
            `;
            if (totals.taxRate > 0) {
                previewHTML += `
                    <tr>
                        <td colspan="3" class="right-align">税(${totals.taxRate * 100}%)</td>
                        <td>¥${totals.tax.toLocaleString()}</td>
                    </tr>
                `;
            }
            previewHTML += `
                    <tr class="total-row">
                        <td colspan="3" class="right-align">合計</td>
                        <td>¥${totals.total.toLocaleString()}</td>
                    </tr>
                </tbody>
                </table>
                <div class="notes-container">備考: ${notes.replace(/\n/g, '<br>')}</div>
            `;
            document.getElementById('preview').innerHTML = previewHTML;
        }

        function downloadPDF() {
            const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
            if (clientMode === 'single') {
                updatePreview();
                generateSinglePDF();
            } else {
                generateMultiplePDF();
            }
        }

        function generateSinglePDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('preview');
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasRatio = canvas.height / canvas.width;
                const imageWidth = pdfWidth;
                const imageHeight = imageWidth * canvasRatio;
                if (imageHeight > pdfHeight) {
                    const scale = pdfHeight / imageHeight;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth * scale, pdfHeight);
                } else {
                    pdf.addImage(imgData, 'PNG', 0, 0, imageWidth, imageHeight);
                }
                const today = new Date();
                const fileName = `請求書_${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}.pdf`;
                pdf.save(fileName);
            });
        }

        function generateMultiplePDF() {
            const { jsPDF } = window.jspdf;
            const dateInput = document.getElementById('date').value || '';
            const notes = document.getElementById('notes').value || '';
            const taxRate = parseFloat(document.getElementById('tax-rate').value);
            let formattedDate = '';
            if (dateInput) {
                const date = new Date(dateInput);
                formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            }
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                if (name) {
                    items.push({
                        name: name,
                        quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                        price: parseFloat(row.querySelector('.item-price').value) || 0,
                        amount: parseFloat(row.querySelector('.item-amount').value) || 0
                    });
                }
            });
            const totals = calculateTotals();
            const clients = [];
            document.querySelectorAll('.client-row').forEach(row => {
                const name = row.querySelector('.client-name').value.trim();
                if (name) {
                    clients.push(name);
                }
            });
            if (clients.length === 0) {
                alert('請求先が設定されていません。');
                return;
            }
            const pdf = new jsPDF('p', 'mm', 'a4');
            const processClient = (index) => {
                if (index >= clients.length) {
                    const today = new Date();
                    const fileName = `請求書_${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}.pdf`;
                    pdf.save(fileName);
                    return;
                }
                const client = clients[index];
                generateInvoicePreview(client, formattedDate, items, totals, notes);
                const element = document.getElementById('preview');
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasRatio = canvas.height / canvas.width;
                    const imageWidth = pdfWidth;
                    const imageHeight = imageWidth * canvasRatio;
                    if (imageHeight > pdfHeight) {
                        const scale = pdfHeight / imageHeight;
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth * scale, pdfHeight);
                    } else {
                        pdf.addImage(imgData, 'PNG', 0, 0, imageWidth, imageHeight);
                    }
                    if (index < clients.length - 1) {
                        pdf.addPage();
                    }
                    processClient(index + 1);
                });
            };
            processClient(0);
        }
    </script>
</body>
</html>
